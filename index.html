<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Comparison Tool</title>
    <script>
        // テキストの正規化（空白、改行、Unicode正規化）
        function normalizeText(text) {
            return text
                .normalize("NFC") // Unicode正規化で微妙な違いを統一
                .trim() // 前後の空白を削除
                .replace(/\s+/g, ' '); // 連続する空白や改行を1つのスペースに統一
        }

        // 差分計算（Myersアルゴリズム）
        function myersDiff(a, b) {
            const m = a.length, n = b.length;
            const max = m + n;
            const v = Array(2 * max + 1).fill(0);
            const trace = [];

            for (let d = 0; d <= max; d++) {
                trace.push([...v]);
                for (let k = -d; k <= d; k += 2) {
                    let x = 0;
                    if (k === -d || (k !== d && v[k - 1 + max] < v[k + 1 + max])) {
                        x = v[k + 1 + max];
                    } else {
                        x = v[k - 1 + max] + 1;
                    }
                    let y = x - k;

                    while (x < m && y < n && a[x] === b[y]) {
                        x++;
                        y++;
                    }

                    v[k + max] = x;
                    if (x >= m && y >= n) {
                        return trace;
                    }
                }
            }
        }

        // 差分ハイライト生成
        function generateHighlightedDiff(a, b, trace) {
            let x = a.length, y = b.length;
            let resultA = '', resultB = '';
            const differences = [];

            for (let d = trace.length - 1; d >= 0; d--) {
                const v = trace[d];
                const k = x - y;
                const prevK = (k === -d || (k !== d && v[k - 1 + v.length / 2] < v[k + 1 + v.length / 2]))
                    ? k + 1
                    : k - 1;
                const prevX = v[prevK + v.length / 2];
                const prevY = prevX - prevK;

                while (x > prevX && y > prevY) {
                    resultA = a[--x] + resultA;
                    resultB = b[--y] + resultB;
                }

                if (x > prevX) {
                    differences.push({ text1: a[--x], text2: '-' });
                    resultA = `<span class="highlight">${a[x]}</span>` + resultA;
                } else if (y > prevY) {
                    differences.push({ text1: '-', text2: b[--y] });
                    resultB = `<span class="highlight">${b[y]}</span>` + resultB;
                }
            }

            while (x > 0) {
                differences.push({ text1: a[--x], text2: '-' });
                resultA = `<span class="highlight">${a[x]}</span>` + resultA;
            }
            while (y > 0) {
                differences.push({ text1: '-', text2: b[--y] });
                resultB = `<span class="highlight">${b[y]}</span>` + resultB;
            }

            return { highlightedA: resultA, highlightedB: resultB, differences };
        }

        // テキスト比較
        function compareTexts() {
            const text1 = normalizeText(document.getElementById("text1").value);
            const text2 = normalizeText(document.getElementById("text2").value);

            const trace = myersDiff(text1, text2);
            const { highlightedA, highlightedB, differences } = generateHighlightedDiff(text1, text2, trace);

            document.getElementById("output1").innerHTML = highlightedA;
            document.getElementById("output2").innerHTML = highlightedB;

            const differencesTable = differences.map(diff => `
                <tr>
                    <td>${diff.text1}</td>
                    <td>${diff.text2}</td>
                </tr>`).join('');
            document.getElementById("differences-summary").innerHTML = `
                <h3>異なる部分の一覧</h3>
                <table>
                    <thead>
                        <tr>
                            <th>テキスト1</th>
                            <th>テキスト2</th>
                        </tr>
                    </thead>
                    <tbody>${differencesTable}</tbody>
                </table>`;
        }
    </script>
    <style>
        /* スタイルはそのまま */
    </style>
</head>

<body>
    <h1>Text Comparison Tool</h1>
    <div style="display: flex; justify-content: space-between;">
        <textarea id="text1" placeholder="テキスト1を入力してください"></textarea>
        <textarea id="text2" placeholder="テキスト2を入力してください"></textarea>
    </div>
    <button onclick="compareTexts()">比較する</button>
    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <div id="output1" class="output"></div>
        <div id="output2" class="output"></div>
    </div>
    <div id="differences-summary">
        <h3>異なる部分の一覧</h3>
        <p>比較を実行すると、異なる部分が表形式で表示されます。</p>
    </div>
</body>

</html>
