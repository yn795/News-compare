<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Performance Text Comparison</title>
    <script>
        // 非同期処理用のWorker生成
        let worker;

        function compareTexts() {
            const text1 = document.getElementById("text1").value;
            const text2 = document.getElementById("text2").value;

            // Workerが未生成なら作成
            if (!worker) {
                worker = new Worker(URL.createObjectURL(new Blob([`
                    onmessage = function (e) {
                        const { text1, text2 } = e.data;

                        // Myersアルゴリズムで差分を計算
                        const diff = (function myersDiff(a, b) {
                            const m = a.length, n = b.length;
                            const max = m + n;
                            const v = Array(2 * max + 1).fill(0);
                            const trace = [];

                            for (let d = 0; d <= max; d++) {
                                trace.push([...v]);
                                for (let k = -d; k <= d; k += 2) {
                                    let x = (k === -d || (k !== d && v[k - 1 + max] < v[k + 1 + max]))
                                        ? v[k + 1 + max]
                                        : v[k - 1 + max] + 1;
                                    let y = x - k;

                                    while (x < m && y < n && a[x] === b[y]) {
                                        x++;
                                        y++;
                                    }

                                    v[k + max] = x;
                                    if (x >= m && y >= n) {
                                        return trace;
                                    }
                                }
                            }
                        })(text1, text2);

                        // 結果をWorkerからメインスレッドに送信
                        postMessage(diff);
                    };
                `], { type: 'text/javascript' })));
            }

            // テキストをWorkerに送信
            worker.postMessage({ text1, text2 });

            // Workerの結果を受け取る
            worker.onmessage = function (e) {
                const diff = e.data;

                // 結果を画面に描画
                document.getElementById("output1").innerHTML = diff.highlightedA;
                document.getElementById("output2").innerHTML = diff.highlightedB;
            };
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        textarea {
            width: 45%;
            height: 300px;
            margin-bottom: 10px;
        }

        .output {
            width: 45%;
            height: 300px;
            overflow: auto;
            padding: 10px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .highlight-added {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .highlight-deleted {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>High-Performance Text Comparison</h1>
    <div style="display: flex; justify-content: space-between;">
        <textarea id="text1" placeholder="テキスト1を入力してください"></textarea>
        <textarea id="text2" placeholder="テキスト2を入力してください"></textarea>
    </div>
    <button onclick="compareTexts()">比較する</button>
    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <div id="output1" class="output"></div>
        <div id="output2" class="output"></div>
    </div>
</body>

</html>
